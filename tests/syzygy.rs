use cinder::syzygy::{Dtz, Syzygy, Wdl};
use cinder::{chess::Position, search::Ply, util::Integer};
use proptest::sample::select;
use reqwest::blocking::get as fetch;
use std::{env, fmt::Debug, fs, io::Write, path::PathBuf, sync::LazyLock};
use test_strategy::proptest;

static SYZYGY: LazyLock<Syzygy> = LazyLock::new(|| {
    const TEST_SYZYGY_TABLES: &[&str] = &[
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KBvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KNvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KNvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KPvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KPvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KQvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KRvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBBvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KBBvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBNvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KBNvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBPvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KBPvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBvKB.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KBvKB.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBvKN.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KBvKN.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBvKP.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KBvKP.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KNNvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KNNvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KNPvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KNPvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KNvKN.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KNvKN.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KNvKP.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KNvKP.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KPPvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KPPvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KPvKP.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KPvKP.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQBvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KQBvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQNvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KQNvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQPvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KQPvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQQvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQRvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KQRvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQvKB.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KQvKB.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQvKN.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KQvKN.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQvKP.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KQvKP.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQvKQ.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KQvKQ.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQvKR.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KQvKR.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRBvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KRBvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRNvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KRNvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRPvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KRPvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRRvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KRRvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRvKB.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KRvKB.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRvKN.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KRvKN.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRvKP.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KRvKP.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRvKR.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KRvKR.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBBvKB.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KBBvKB.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBBvKN.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KBBvKN.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBBvKP.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KBBvKP.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBBvKQ.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KBBvKQ.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBBvKR.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KBBvKR.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBNvKB.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBNvKN.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBNvKP.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBNvKQ.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBNvKR.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KBNvKR.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBPvKB.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBPvKN.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBPvKP.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KBPvKP.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBPvKQ.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KBPvKR.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KNNvKR.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KNPvKR.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KPPvKR.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KPPvKR.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQBBvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQBNvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQBPvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQBvKB.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQBvKN.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQBvKP.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQBvKQ.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQBvKR.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQNNvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQNPvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQNvKQ.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQNvKR.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQPPvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KQPPvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQPvKR.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQQBvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQQNvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQQPvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQQQvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KQQQvK.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQQRvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQQvKR.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQRBvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQRNvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQRPvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQRRvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQRvKB.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQRvKN.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQRvKP.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQRvKQ.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KQRvKR.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRBvKB.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRBvKN.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRBvKP.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRBvKQ.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRBvKR.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRNvKB.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRNvKN.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRNvKP.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRNvKQ.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRNvKR.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRPvKB.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRPvKN.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRPvKP.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-dtz/KRPvKP.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRPvKQ.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRPvKR.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRRvKB.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRRvKN.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRRvKP.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRRvKQ.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/3-4-5-wdl/KRRvKR.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/6-wdl/KQQQQvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/6-wdl/KQRNvKQ.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/6-dtz/KQRNvKQ.rtbz",
        "https://tablebase.lichess.ovh/tables/standard/7/6v1_pawnless/KQQQQQvK.rtbw",
        "https://tablebase.lichess.ovh/tables/standard/7/6v1_pawnless/KQQQQQvK.rtbz",
    ];

    let root = env!("CARGO_TARGET_TMPDIR");
    let syzygy = PathBuf::from(root).join("syzygy");
    fs::create_dir_all(&syzygy).unwrap();
    for url in TEST_SYZYGY_TABLES {
        let file = syzygy.join(url.split('/').next_back().unwrap());
        if !file.exists() {
            println!("fetching {url}");
            let mut file = fs::File::create_new(file).unwrap();
            let body = fetch(*url).unwrap().bytes().unwrap();
            file.write_all(&body).unwrap();
        }
    }

    let syzygy = Syzygy::new(&[syzygy]);
    assert_eq!(syzygy.max_pieces(), 7);

    syzygy
});

#[rustfmt::skip]
const SYZYGY_SUITE: &[(&str, Wdl, i16, &str)] = &[
    ("1B6/8/8/1Q6/8/k7/8/7K b - - 10 5", Wdl::Loss, -6, "a3a2"),
    ("1bB5/8/1k6/8/8/8/6K1/8 b - - 10 5", Wdl::Draw, 0, "b8h2"),
    ("1k4b1/8/1r2K3/8/8/8/8/8 w - - 10 5", Wdl::Loss, -18, "e6e5"),
    ("1k6/1R3P2/8/8/8/8/8/6K1 b - - 10 5", Wdl::Loss, -2, "b8b7"),
    ("1k6/4P3/8/5QK1/8/8/8/8 b - - 10 5", Wdl::Loss, -2, "b8a7"),
    ("1K6/8/6B1/8/8/8/5B2/k7 b - - 10 5", Wdl::Loss, -27, "a1a2"),
    ("1K6/8/8/8/5k2/1Q6/8/5b2 b - - 10 5", Wdl::Loss, -22, "f1e2"),
    ("1kB5/3K4/8/pP6/8/8/8/8 w - a6 10 5", Wdl::Win, 1, "b5a6"),
    ("1kB5/p2K4/8/1P6/8/8/8/8 b - - 10 5", Wdl::Loss, -2, "b8a8"),
    ("1n6/4Q3/8/k1K5/8/8/8/8 b - - 10 5", Wdl::Loss, -14, "b8a6"),
    ("1n6/8/8/3k4/8/1K2n3/8/8 w - - 10 5", Wdl::Draw, 0, "b3a2"),
    ("1r4k1/8/8/p7/8/8/8/K7 b - - 10 5", Wdl::Win, 1, "a5a4"),
    ("1R6/3k4/8/8/8/1K6/8/2q5 b - - 10 5", Wdl::Win, 3, "c1b1"),
    ("1r6/5k2/1n6/8/8/K7/8/8 w - - 10 5", Wdl::Loss, -16, "a3b2"),
    ("2b4q/4K3/8/5k2/8/8/8/8 b - - 10 5", Wdl::Win, 3, "h8f6"),
    ("2b5/3K4/4R3/3k4/8/8/8/8 w - - 10 5", Wdl::Draw, 0, "d7c8"),
    ("2B5/8/1K6/r7/5k2/8/8/8 w - - 10 5", Wdl::Draw, 0, "b6a5"),
    ("2k1b3/1q6/8/8/8/8/K7/8 w - - 10 5", Wdl::Loss, -6, "a2a1"),
    ("2K1N3/8/8/8/8/7p/4k3/8 b - - 10 5", Wdl::Win, 1, "h3h2"),
    ("2K5/8/2P5/8/4k3/8/3r4/8 w - - 10 5", Wdl::Draw, 0, "c6c7"),
    ("2k5/8/4N3/2K5/8/1b6/8/8 b - - 10 5", Wdl::Draw, 0, "b3e6"),
    ("2k5/8/8/1q2K1n1/8/8/8/8 w - - 10 5", Wdl::Loss, -10, "e5d4"),
    ("2K5/8/8/8/6P1/8/2n5/1k6 w - - 10 5", Wdl::Draw, 0, "g4g5"),
    ("2K5/8/8/kr6/8/8/8/4b3 b - - 10 5", Wdl::Win, 11, "b5d5"),
    ("2kn4/8/K7/8/4R3/8/8/8 b - - 10 5", Wdl::Draw, 0, "d8c6"),
    ("2q5/8/8/8/6N1/8/4K3/k7 w - - 10 5", Wdl::Loss, -30, "g4f2"),
    ("3B4/K7/8/k3N3/8/8/8/8 b - - 10 5", Wdl::Loss, -53, "a5b4"),
    ("3K1b2/2R5/8/8/8/1k6/8/8 w - - 10 5", Wdl::Draw, 0, "c7c1"),
    ("3k4/3rq3/8/1K6/8/8/8/8 w - - 10 5", Wdl::Loss, -4, "b5a5"),
    ("3K4/4n3/2k5/8/b7/8/8/8 w - - 10 5", Wdl::Draw, 0, "d8e7"),
    ("3K4/8/3k4/8/4p3/4B3/5P2/8 w - - 10 5", Wdl::Win, 15, "e3b6"),
    ("3K4/8/3k4/8/4pP2/4B3/8/8 b - f3 10 5", Wdl::Draw, 0, "e4f3"),
    ("3K4/8/8/8/8/8/2k2b1N/8 b - - 10 5", Wdl::Draw, 0, "f2e1"),
    ("3Kb3/7k/8/8/8/8/4Q3/8 b - - 10 5", Wdl::Loss, -10, "e8g6"),
    ("3R4/3K4/8/8/k7/8/n7/8 b - - 10 5", Wdl::Draw, 0, "a2c1"),
    ("4b3/4n3/8/8/2k5/8/3K4/8 w - - 10 5", Wdl::Loss, -47, "d2e3"),
    ("4b3/6k1/8/8/8/8/7b/4K3 b - - 10 5", Wdl::Win, 28, "h2d6"),
    ("4k3/2b5/2N5/8/4K3/8/8/8 b - - 10 5", Wdl::Draw, 0, "c7h2"),
    ("4K3/4q3/6p1/2k5/6p1/8/8/8 w - - 10 5", Wdl::Loss, -1, "e8e7"),
    ("4K3/8/8/7B/8/4R3/2k5/8 b - - 10 5", Wdl::Loss, -20, "c2d2"),
    ("4K3/8/8/8/1Q6/3b4/7k/8 b - - 10 5", Wdl::Loss, -18, "d3f1"),
    ("4k3/8/8/8/8/4b3/1K6/n7 b - - 10 5", Wdl::Win, 56, "e3d4"),
    ("4k3/8/8/8/8/8/P2Kp3/8 b - - 10 5", Wdl::Draw, 0, "e2e1q"),
    ("4Kn2/2R5/8/8/8/3k4/8/8 b - - 10 5", Wdl::Draw, 0, "f8e6"),
    ("4n3/8/7b/8/8/7K/8/7k w - - 10 5", Wdl::Loss, -51, "h3g3"),
    ("4QK2/8/5k2/8/8/8/b7/8 w - - 10 5", Wdl::Win, 9, "e8e7"),
    ("4r3/8/8/2K5/8/8/3P4/k7 w - - 10 5", Wdl::Draw, 0, "d2d4"),
    ("5b2/8/2kq4/4K3/8/8/8/8 w - - 10 5", Wdl::Loss, -10, "e5f5"),
    ("5BrN/8/8/8/8/2k5/8/2K5 b - - 10 5", Wdl::Win, 1, "g8g1"),
    ("5K2/1Pk5/4b3/8/8/8/8/8 b - - 10 5", Wdl::Draw, 0, "c7b7"),
    ("5k2/5P2/8/8/8/8/4B3/1K6 b - - 10 5", Wdl::Draw, 0, "f8f7"),
    ("5k2/8/4K3/8/3r1B2/8/8/8 b - - 10 5", Wdl::Win, 1, "d4f4"),
    ("5K2/8/8/8/8/8/N7/4k2n b - - 10 5", Wdl::Draw, 0, "h1f2"),
    ("5N2/8/8/6K1/1k6/8/3n4/8 w - - 10 5", Wdl::Draw, 0, "f8e6"),
    ("5Q2/8/8/2k5/8/8/2K5/6B1 b - - 10 5", Wdl::Loss, -8, "c5d5"),
    ("5r1K/8/8/8/8/6n1/7k/8 w - - 10 5", Wdl::Loss, -14, "h8g7"),
    ("5R2/1K6/8/4N3/8/8/8/1k6 w - - 10 5", Wdl::Win, 13, "e5c4"),
    ("6B1/8/8/1n6/8/5k2/8/1K6 w - - 10 5", Wdl::Draw, 0, "g8a2"),
    ("6k1/1n6/1B6/8/8/8/8/2K5 w - - 10 5", Wdl::Draw, 0, "b6g1"),
    ("6k1/8/8/8/8/4n3/8/K7 b - - 10 5", Wdl::Draw, 0, "e3d1"),
    ("6N1/8/8/2k5/7N/1K6/8/8 b - - 10 5", Wdl::Draw, 0, "c5d4"),
    ("6n1/8/8/8/4r3/8/k4K2/8 w - - 10 5", Wdl::Loss, -18, "f2f1"),
    ("6Q1/5NR1/8/8/1q6/2k5/8/2K5 b - - 10 5", Wdl::Win, 2, "b4b2"),
    ("6Q1/5NR1/8/8/8/2k5/1q6/2K5 w - - 10 5", Wdl::Loss, -1, "c1d1"),
    ("6Q1/5NR1/8/8/8/2k5/1q6/3K4 b - - 10 5", Wdl::Win, 1, "b2d2"),
    ("6Q1/5NR1/8/8/8/2k5/3q4/3K4 w - - 10 5", Wdl::Loss, -1, ""),
    ("6Q1/8/1K6/8/1p5k/8/8/8 b - - 10 5", Wdl::Loss, -4, "h4h3"),
    ("6q1/8/6K1/4R3/1k6/8/8/8 w - - 10 5", Wdl::Loss, -46, "g6f5"),
    ("6R1/8/5b2/5K2/8/8/8/1k6 b - - 10 5", Wdl::Draw, 0, "f6a1"),
    ("6r1/8/5K2/8/8/8/8/1k1n4 b - - 10 5", Wdl::Win, 21, "d1c3"),
    ("7B/2k5/8/8/6p1/8/8/1K6 w - - 10 5", Wdl::Draw, 0, "h8a1"),
    ("7B/8/8/7B/8/3k4/8/6K1 b - - 10 5", Wdl::Loss, -33, "d3c4"),
    ("7k/1R6/8/8/8/8/4r3/K7 w - - 10 5", Wdl::Draw, 0, "b7b1"),
    ("7k/5K2/6q1/8/8/8/8/2Q5 w - - 10 5", Wdl::Win, 1, "f7g6"),
    ("7K/6p1/8/8/k1R5/8/8/8 b - - 10 5", Wdl::Loss, -4, "a4b3"),
    ("7k/8/5K2/4Q3/3Q4/2Q5/1Q6/Q7 b - - 10 5", Wdl::Loss, -4, "h8h7"),
    ("7K/8/8/8/4k3/1N6/3n4/8 b - - 10 5", Wdl::Draw, 0, "d2b3"),
    ("7k/8/8/8/8/3q4/3qq3/2K5 w - - 10 5", Wdl::Loss, -1, ""),
    ("7K/8/8/N3k3/7P/8/8/8 b - - 10 5", Wdl::Draw, 0, "e5f4"),
    ("7N/8/8/7P/8/1K6/8/5k2 w - - 10 5", Wdl::Win, 1, "h5h6"),
    ("7N/q7/8/7K/1k6/8/8/8 w - - 10 5", Wdl::Loss, -20, "h8g6"),
    ("7Q/8/4k3/6K1/n7/8/8/8 w - - 10 5", Wdl::Win, 3, "h8d4"),
    ("7R/8/8/8/8/N1k5/8/5K2 w - - 10 5", Wdl::Win, 11, "h8h4"),
    ("7R/8/8/8/B6k/8/8/K7 b - - 10 5", Wdl::Loss, -22, "h4g4"),
    ("8/1K6/1b6/8/8/4n3/2k5/8 b - - 10 5", Wdl::Win, 52, "e3c4"),
    ("8/1K6/1R6/8/8/8/2k5/5B2 w - - 10 5", Wdl::Win, 15, "f1d3"),
    ("8/1K6/4q3/8/8/6p1/8/2k5 w - - 10 5", Wdl::Loss, -2, "b7a7"),
    ("8/1KP5/8/8/8/2N1k3/8/8 w - - 10 5", Wdl::Win, 1, "c7c8q"),
    ("8/1p3K2/4R3/8/8/5k2/8/8 w - - 10 5", Wdl::Win, 3, "e6b6"),
    ("8/2B5/2k5/8/2K5/3n4/8/8 w - - 10 5", Wdl::Draw, 0, "c4d3"),
    ("8/2k5/8/1K6/4n3/8/7n/8 w - - 10 5", Wdl::Draw, 0, "b5a4"),
    ("8/2k5/8/8/2n5/8/8/K5q1 w - - 10 5", Wdl::Loss, -4, "a1a2"),
    ("8/2K5/8/8/8/4k2N/8/6n1 w - - 10 5", Wdl::Draw, 0, "h3g1"),
    ("8/2k5/8/8/8/4Qr2/6K1/8 b - - 10 5", Wdl::Win, 1, "f3e3"),
    ("8/2K5/8/8/8/8/3p4/1k2N3 b - - 10 5", Wdl::Win, 1, "d2e1q"),
    ("8/2k5/p7/3K2P1/8/8/8/8 b - - 10 5", Wdl::Draw, 0, "c7d7"),
    ("8/2q5/8/8/1k6/7K/8/7B w - - 10 5", Wdl::Loss, -14, "h1g2"),
    ("8/3K4/5k2/8/1N6/4n3/8/8 b - - 10 5", Wdl::Draw, 0, "e3d1"),
    ("8/3K4/8/8/1k6/1B4P1/8/8 w - - 10 5", Wdl::Win, 1, "g3g4"),
    ("8/3k4/8/8/8/4q3/3K4/7r w - - 10 5", Wdl::Loss, -2, "d2e3"),
    ("8/3k4/8/8/8/8/4P3/3K4 w - - 10 5", Wdl::Draw, 0, "e2e3"),
    ("8/3p4/5p2/2K5/8/8/8/2k5 b - - 10 5", Wdl::Win, 1, "f6f5"),
    ("8/3r4/7K/5R2/8/8/8/5k2 b - - 10 5", Wdl::Draw, 0, "f1e1"),
    ("8/4K3/2P5/4k3/7B/8/8/8 w - - 10 5", Wdl::Win, 1, "c6c7"),
    ("8/4K3/5r2/8/8/8/6k1/7b w - - 10 5", Wdl::Draw, 0, "e7f6"),
    ("8/4K3/8/2B1k3/8/8/7P/8 b - - 10 5", Wdl::Loss, -2, "e5e4"),
    ("8/4K3/8/2k5/8/8/8/5Q1N b - - 10 5", Wdl::Loss, -12, "c5b4"),
    ("8/4k3/8/7P/5K2/2b5/8/8 w - - 10 5", Wdl::Draw, 0, "h5h6"),
    ("8/4p2K/3B4/7k/8/8/8/8 b - - 10 5", Wdl::Win, 1, "e7d6"),
    ("8/4P3/1k2K3/8/8/8/8/6R1 b - - 10 5", Wdl::Loss, -2, "b6a5"),
    ("8/4p3/8/3n4/6K1/8/8/6k1 w - - 10 5", Wdl::Loss, -4, "g4f5"),
    ("8/4r3/8/K7/4R3/8/8/5k2 w - - 10 5", Wdl::Win, 1, "e4e7"),
    ("8/5k2/1K6/8/8/6n1/8/2B5 w - - 10 5", Wdl::Draw, 0, "c1b2"),
    ("8/5K2/3k1r2/8/8/8/2Q5/8 w - - 10 5", Wdl::Win, 1, "f7f6"),
    ("8/5k2/8/6n1/7r/7K/8/8 w - - 10 5", Wdl::Draw, 0, "h3h4"),
    ("8/5p2/6k1/K7/8/8/8/8 w - - 10 5", Wdl::Loss, -2, "a5a4"),
    ("8/5q2/8/2K5/8/8/k7/1R6 w - - 10 5", Wdl::Loss, -54, "b1b4"),
    ("8/6B1/8/8/B7/8/K1pk4/8 b - - 10 5", Wdl::BlessedLoss, -101, "c2c1n"),
    ("8/6B1/8/8/B7/8/K2k4/2n5 w - - 10 5", Wdl::CursedWin, 109, "a2a3"),
    ("8/6k1/4K3/6B1/8/8/5N2/8 w - - 10 5", Wdl::Win, 20, "f2d3"),
    ("8/6K1/6R1/6R1/7k/8/8/8 w - - 10 5", Wdl::Win, 1, "g5h5"),
    ("8/6k1/8/8/3K4/b7/1Q6/8 w - - 10 5", Wdl::Win, 1, "b2a3"),
    ("8/6K1/8/8/4Q3/7p/1k6/8 b - - 10 5", Wdl::Loss, -4, "b2c1"),
    ("8/6k1/8/8/8/3Q4/8/4K2N b - - 10 5", Wdl::Loss, -12, "g7f6"),
    ("8/6N1/8/8/7k/8/p7/4K3 b - - 10 5", Wdl::Win, 1, "a2a1q"),
    ("8/6P1/p7/8/8/8/8/1K1k4 w - - 10 5", Wdl::Win, 1, "g7g8q"),
    ("8/7k/8/4KP2/8/8/1p6/8 w - - 10 5", Wdl::Loss, -1, "e5d4"),
    ("8/7k/8/8/3K4/pQ6/8/8 w - - 10 5", Wdl::Win, 1, "b3a3"),
    ("8/7k/K7/6r1/8/5R2/8/8 w - - 10 5", Wdl::Draw, 0, "f3f1"),
    ("8/7n/8/N1K5/6k1/8/8/8 w - - 10 5", Wdl::Draw, 0, "a5b3"),
    ("8/7p/8/8/8/bk6/8/1K6 w - - 10 5", Wdl::Loss, -2, "b1a1"),
    ("8/7r/8/1k4K1/8/8/8/3B4 w - - 10 5", Wdl::Draw, 0, "d1c2"),
    ("8/8/1B6/4K3/8/6B1/4k3/8 b - - 10 5", Wdl::Draw, 0, "e2d1"),
    ("8/8/1b6/8/8/8/1k4QK/8 b - - 10 5", Wdl::Loss, -18, "b2a3"),
    ("8/8/1k6/3K4/1b5r/8/8/8 w - - 10 5", Wdl::Loss, -16, "d5e5"),
    ("8/8/1k6/8/2R2R2/8/6K1/8 w - - 10 5", Wdl::Win, 5, "c4c1"),
    ("8/8/1k6/8/8/5q2/n7/5K2 w - - 10 5", Wdl::Loss, -8, "f1g1"),
    ("8/8/1n5B/8/8/8/6K1/2k5 b - - 10 5", Wdl::Draw, 0, "c1b1"),
    ("8/8/1n6/8/7K/8/3k4/1Q6 w - - 10 5", Wdl::Win, 1, "b1b6"),
    ("8/8/1Pk5/8/8/4b3/8/7K b - - 10 5", Wdl::Draw, 0, "e3b6"),
    ("8/8/2K5/k7/1q6/5r2/8/8 w - - 10 5", Wdl::Loss, -4, "c6d5"),
    ("8/8/2kb4/8/8/7Q/8/7K b - - 10 5", Wdl::Loss, -22, "d6b4"),
    ("8/8/2N5/3k4/8/1K6/2b5/8 w - - 10 5", Wdl::Draw, 0, "b3c2"),
    ("8/8/2q1k3/8/5K2/8/3r4/8 w - - 10 5", Wdl::Loss, -6, "f4g4"),
    ("8/8/2Q5/8/8/1b6/7K/1k6 w - - 10 5", Wdl::Win, 15, "c6c3"),
    ("8/8/2r5/6bk/8/8/6K1/8 b - - 10 5", Wdl::Win, 9, "c6f6"),
    ("8/8/2r5/8/k7/3K4/6r1/8 w - - 10 5", Wdl::Loss, -6, "d3e4"),
    ("8/8/3b4/6K1/8/8/1Q6/1k6 b - - 10 5", Wdl::Draw, 0, "b1b2"),
    ("8/8/3K4/3n4/8/3k4/8/4n3 b - - 10 5", Wdl::Draw, 0, "e1c2"),
    ("8/8/3K4/5P2/Q7/8/1k6/8 w - - 10 5", Wdl::Win, 1, "f5f6"),
    ("8/8/3k4/8/8/6KN/3N4/8 b - - 10 5", Wdl::Draw, 0, "d6c5"),
    ("8/8/3P1K1p/1k6/8/8/8/8 b - - 10 5", Wdl::Loss, -3, "b5c6"),
    ("8/8/3p1k2/8/8/6K1/8/4n3 w - - 10 5", Wdl::Loss, -4, "g3f2"),
    ("8/8/3Q4/8/8/8/q7/4k1K1 b - - 10 5", Wdl::Draw, 0, "a2a1"),
    ("8/8/4K3/8/8/1k6/8/4RN2 b - - 10 5", Wdl::Loss, -16, "b3c4"),
    ("8/8/4K3/k7/4q3/8/6p1/8 w - - 10 5", Wdl::Loss, -2, "e6d6"),
    ("8/8/5k2/8/2K5/3N4/2B5/8 w - - 10 5", Wdl::Win, 48, "c4d5"),
    ("8/8/5N2/6K1/8/3kN3/8/8 w - - 10 5", Wdl::Draw, 0, "e3d1"),
    ("8/8/6k1/2r5/6K1/8/N7/8 w - - 10 5", Wdl::Draw, 0, "g4f3"),
    ("8/8/6K1/8/4n3/4p1k1/8/8 b - - 10 5", Wdl::Win, 1, "e3e2"),
    ("8/8/6K1/8/p7/5R2/6k1/8 w - - 10 5", Wdl::Win, 3, "f3a3"),
    ("8/8/8/1B6/5K2/3n4/8/5k2 w - - 10 5", Wdl::Draw, 0, "b5d3"),
    ("8/8/8/1K6/8/7Q/8/3kb3 w - - 10 5", Wdl::Win, 7, "h3f1"),
    ("8/8/8/1N1Q4/2K5/6k1/8/8 w - - 10 5", Wdl::Win, 9, "b5d4"),
    ("8/8/8/2K5/5kp1/8/8/8 b - - 10 5", Wdl::Win, 1, "g4g3"),
    ("8/8/8/2k5/8/2b5/8/K2R4 w - - 10 5", Wdl::Draw, 0, "a1b1"),
    ("8/8/8/2R5/1K6/8/5k2/8 w - - 10 5", Wdl::Win, 21, "c5c3"),
    ("8/8/8/3k2P1/8/8/3q4/K7 b - - 10 5", Wdl::Win, 1, "d2g5"),
    ("8/8/8/3k4/6p1/8/P7/2K5 b - - 10 5", Wdl::Win, 1, "g4g3"),
    ("8/8/8/3Kn3/8/8/4k3/N7 b - - 10 5", Wdl::Draw, 0, "e5d3"),
    ("8/8/8/3p4/7b/8/6K1/3k4 b - - 10 5", Wdl::Win, 1, "d5d4"),
    ("8/8/8/3q4/8/5k1P/7K/8 w - - 10 5", Wdl::Loss, -4, "h2g1"),
    ("8/8/8/3R1p2/8/1k6/3K4/8 b - - 10 5", Wdl::Loss, -2, "b3a2"),
    ("8/8/8/3r4/2K5/8/2k3n1/8 w - - 10 5", Wdl::Draw, 0, "c4d5"),
    ("8/8/8/4Kp2/2k5/8/8/7B w - - 10 5", Wdl::Draw, 0, "e5f5"),
    ("8/8/8/5Q2/6K1/1k6/7p/8 w - - 10 5", Wdl::Win, 3, "f5h5"),
    ("8/8/8/7K/7r/7N/8/4k3 w - - 10 5", Wdl::Draw, 0, "h5h4"),
    ("8/8/8/8/4k3/2q5/3K4/6r1 w - - 10 5", Wdl::Loss, -2, "d2c3"),
    ("8/8/8/8/4k3/8/8/1R2R1K1 b - - 10 5", Wdl::Loss, -8, "e4f5"),
    ("8/8/8/8/4P3/6k1/5N2/4K3 w - - 10 5", Wdl::Win, 1, "e4e5"),
    ("8/8/8/8/5k2/3Kb3/8/1N6 w - - 10 5", Wdl::Draw, 0, "b1d2"),
    ("8/8/8/8/5r2/8/3N2k1/3K4 w - - 10 5", Wdl::Draw, 0, "d2b1"),
    ("8/8/8/8/7K/p4k2/8/1r6 w - - 10 5", Wdl::Loss, -2, "h4h3"),
    ("8/8/8/8/7r/6q1/2K5/6k1 w - - 10 5", Wdl::Loss, -4, "c2b1"),
    ("8/8/8/8/8/1K2B3/b6k/8 w - - 10 5", Wdl::Draw, 0, "b3a2"),
    ("8/8/8/8/8/1q3k2/8/2R4K w - - 10 5", Wdl::Loss, -8, "c1f1"),
    ("8/8/8/8/pP6/k7/8/KR6 b - b3 10 5", Wdl::Loss, -1, "a4b3"),
    ("8/8/8/N2K1k2/P7/8/8/8 b - - 10 5", Wdl::Loss, -4, "f5f4"),
    ("8/8/K4k2/7q/8/8/7Q/8 b - - 10 5", Wdl::Win, 1, "h5h2"),
    ("8/8/k5N1/8/8/5p2/8/1K6 b - - 10 5", Wdl::Win, 1, "f3f2"),
    ("8/8/K7/5k2/3R4/8/7b/8 w - - 10 5", Wdl::Draw, 0, "d4d1"),
    ("8/8/q1P5/8/5k2/8/8/6K1 b - - 10 5", Wdl::Win, 1, "a6c6"),
    ("8/8/Q1q5/8/8/2k5/4K3/8 w - - 10 5", Wdl::Win, 1, "a6c6"),
    ("8/8/R2k4/8/8/K7/8/4r3 b - - 10 5", Wdl::Draw, 0, "d6c5"),
    ("8/8/r7/8/7k/8/2K5/5N2 b - - 10 5", Wdl::Draw, 0, "a6a1"),
    ("8/k3p3/b7/8/8/K7/8/8 b - - 10 5", Wdl::Win, 1, "e7e5"),
    ("8/k7/8/3q4/8/7Q/2K5/8 b - - 10 5", Wdl::Draw, 0, "d5a2"),
    ("8/k7/8/5N2/8/4K3/3r4/8 w - - 10 5", Wdl::Draw, 0, "e3d2"),
    ("8/Q7/8/1K6/2B5/1k6/8/8 b - - 10 5", Wdl::Loss, -8, "b3c3"),
    ("B3K2B/8/8/8/8/8/4k3/8 b - - 10 5", Wdl::Loss, -33, "e2d2"),
    ("K2R4/8/8/8/2n5/8/8/6k1 w - - 10 5", Wdl::Draw, 0, "d8d1"),
    ("K5n1/8/8/7n/k7/8/8/8 w - - 10 5", Wdl::Draw, 0, "a8a7"),
    ("K6k/8/2R5/8/8/pp6/8/8 w - - 10 5", Wdl::Loss, -9, "c6c8"),
    ("K6k/8/8/8/8/ppR5/8/8 b - - 10 5", Wdl::Win, 1, "a3a2"),
    ("K7/3n4/6r1/8/8/4k3/8/8 w - - 10 5", Wdl::Loss, -12, "a8b7"),
    ("K7/3q4/5R2/5k2/8/8/8/8 b - - 10 5", Wdl::Win, 1, "f5f6"),
    ("K7/5N2/8/8/3p4/8/k7/8 w - - 10 5", Wdl::Draw, 0, "f7e5"),
    ("k7/7K/8/p7/6n1/8/8/8 w - - 10 5", Wdl::Loss, -2, "h7g6"),
    ("K7/8/4B3/5k2/8/8/8/2n5 b - - 10 5", Wdl::Draw, 0, "f5e6"),
    ("K7/8/5r2/8/3k4/5p2/8/8 w - - 10 5", Wdl::Loss, -2, "a8a7"),
    ("K7/8/8/3R4/8/8/7B/7k b - - 10 5", Wdl::Loss, -16, "h1h2"),
    ("K7/8/b3N3/7k/8/8/8/8 w - - 10 5", Wdl::Draw, 0, "e6d4"),
    ("K7/8/k7/Pp6/8/8/8/8 w - b6 10 5", Wdl::Draw, 0, "a5b6"),
    ("k7/8/K7/Pp6/8/8/8/8 w - b6 10 5", Wdl::Win, 1, "a5b6"),
    ("kr6/8/K7/Pp6/8/8/8/8 w - b6 10 5", Wdl::Loss, -1, "a5b6"),
    ("n7/8/8/8/1K6/6k1/2r5/8 w - - 10 5", Wdl::Loss, -18, "b4a3"),
    ("q7/8/8/2b2k2/8/3K4/8/8 b - - 10 5", Wdl::Win, 5, "a8a2"),
    ("q7/k2K4/5B2/8/8/8/8/8 b - - 10 5", Wdl::Win, 19, "a8d5"),
    ("R7/8/6k1/8/8/8/2K4r/8 w - - 10 5", Wdl::Draw, 0, "c2b1"),
    ("R7/8/6R1/8/7k/1K6/8/8 b - - 10 5", Wdl::Loss, -2, "h4h3"),
];

#[proptest]
fn probing_syzygy_tablebase_finds_wdl(
    #[strategy(select(SYZYGY_SUITE))] entry: (&'static str, Wdl, i16, &'static str),
) {
    let (fen, wdl, _, _) = entry;
    let pos = fen.parse()?;
    assert_eq!(SYZYGY.wdl(&pos), Some(wdl));
}

#[proptest]
fn probing_syzygy_tablebase_finds_dtz(
    #[strategy(select(SYZYGY_SUITE))] entry: (&'static str, Wdl, i16, &'static str),
) {
    let (fen, _, dtz, _) = entry;
    let pos = fen.parse()?;
    assert_eq!(SYZYGY.dtz(&pos), Some(Dtz::new(dtz)));
}

#[proptest]
fn probing_syzygy_tablebase_finds_best_move(
    #[strategy(select(SYZYGY_SUITE))] entry: (&'static str, Wdl, i16, &'static str),
) {
    let (fen, wdl, _, m) = entry;
    let pos: Position = fen.parse()?;

    assert_eq!(
        SYZYGY
            .best(&pos)
            .and_then(|pv| Some((pv.score(), pv.head()?.to_string()))),
        if !m.is_empty() {
            Some((wdl.to_score(Ply::new(0)), m.to_string()))
        } else {
            None
        },
    );
}
